<!--
 * @Author: lcr
 * @Date: 2021-05-08 14:30:16
 * @LastEditTime: 2021-05-12 17:12:07
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \imageCompressTool\test.html
-->
<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Image Compress Tool</title>
    <style>
        .originImage {
            width: 300px;
            height: 00px;
        }
        .compressImage {
            width: auto;
        }
        .fileTip {
            color: red;
        }
    </style>
  </head>
  <body>
    <noscript>
      <strong>We're sorry but vue-antd-pro doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app">
      <input id="inputFile" type="file" name="file" onchange="handleFileChange()">
      <div class="fileTip"></div>
      <img class="originImage">
      <img class="compressImage">
    </div>
    <script type="text/javascript" src="./index.js"></script>
    <script>
        var fileTip = document.getElementsByClassName('fileTip')
        var originImage = document.getElementsByClassName('originImage')
        var smallImage = document.getElementsByClassName('compressImage')
        var inputFile = document.getElementById('inputFile')
        function handleFileChange ()  {
            const files = inputFile.files
            if(files && files[0]) {
                const file = files[0]
                blob2Base64(file, function (base64Data) { // blob 转base64
                    var formatArr = ['jpg', 'png', 'jpeg']
                    if (!file.type.split('image/')[1] || !formatArr.includes(file.type.split('image/')[1].toLowerCase())) {
                        fileTip.innerHTML = '上传图片只能是jpg/jpeg/png格式!'
                        return false
                    }
                    originImage[0].src = base64Data
                    if (base64Data.length > (500 * 1024)) { // 图片大小大于500K就压缩
                        fileTip.innerHTML = ''
                        const img = new Image()
                        img.src = base64Data
                        const timout = setTimeout(() => {
                            var imageDataType = 'blob'
                            compress(img, 1, 600, 0.5, file.type, imageDataType, function (data) {
                                if (imageDataType === 'base64Url') {
                                    data = base642Blob(data) // base64转blob
                                }
                                // let newFile = new File( // 也可以手动new一个File格式的文件，第一个参数为文件blob数据，格式是数组；第二个参数是文件名
                                //   [imgBlob],
                                //   file.name
                                // )
                                file.raw = data // 后端接口需要将文件blob格式的数据放到file.raw中
                                file.url = URL.createObjectURL(data)
                                smallImage[0].src = file.url
                                clearTimeout(timout)
                            })
                        }, 500) // 延时添加用来给压缩过程留一些时间，否则会出现压缩失效的情况
                    } else {
                        file.base64 = base64Data
                        smallImage[0].src = base64Data
                        file.url = URL.createObjectURL(file.raw)
                    }
                })
            }
        }
    </script>
  </body>
</html>
